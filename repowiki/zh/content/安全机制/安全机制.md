# 安全机制

<cite>
**本文档引用的文件**  
- [AuthInterceptor.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/aop/AuthInterceptor.java)
- [AuthCheck.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/annotation/AuthCheck.java)
- [PasswordUtil.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/PasswordUtil.java)
- [GlobalExceptionHandler.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/exception/GlobalExceptionHandler.java)
- [StrAttackFilter.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/filter/StrAttackFilter.java)
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java)
- [WebSocketServer.java](file://yun-docker-worker/src/main/java/com/lfc/yundocker/worker/websocket/WebSocketServer.java)
- [application.yml](file://yun-docker-master/src/main/resources/application.yml)
- [UserConstant.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/constant/UserConstant.java)
- [UserRoleEnum.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/model/enums/UserRoleEnum.java)
</cite>

## 目录
1. [认证与权限控制机制](#认证与权限控制机制)
2. [用户密码存储方案](#用户密码存储方案)
3. [全局异常处理与错误响应](#全局异常处理与错误响应)
4. [输入校验与敏感信息防护](#输入校验与敏感信息防护)
5. [API调用频率限制与Token管理](#api调用频率限制与token管理)
6. [WebSocket连接安全](#websocket连接安全)
7. [潜在风险点与加固建议](#潜在风险点与加固建议)

## 认证与权限控制机制

系统通过 `AuthInterceptor` 拦截器结合 `@AuthCheck` 注解实现接口级别的权限控制。该机制基于Spring AOP实现，通过环绕通知（@Around）在方法执行前进行权限校验。

`@AuthCheck` 注解定义在 `yun-docker-master` 模块中，支持通过 `mustRole` 参数指定接口所需的最小角色权限，如 `ADMIN` 或 `USER`。该注解应用于控制器方法上，例如在 `UserController` 中，`addUser`、`deleteUser` 等管理操作均标注了 `@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)`，确保只有管理员角色才能调用。

`AuthInterceptor` 拦截器在执行时，首先从请求中获取当前登录用户信息（通过 `userService.getLoginUser(request)`），然后根据注解中声明的 `mustRole` 值进行比对。系统定义了 `USER`、`ADMIN`、`BAN` 三种角色，并通过 `UserRoleEnum` 枚举类进行管理。若用户角色不符合要求或已被封禁，则抛出 `BusinessException` 异常，拒绝访问。

该权限控制机制实现了细粒度的访问控制，确保不同角色用户只能访问其权限范围内的API接口。

**Section sources**
- [AuthInterceptor.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/aop/AuthInterceptor.java#L40-L67)
- [AuthCheck.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/annotation/AuthCheck.java#L16-L28)
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L148-L150)
- [UserConstant.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/constant/UserConstant.java#L20-L30)
- [UserRoleEnum.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/model/enums/UserRoleEnum.java#L16-L18)

## 用户密码存储方案

系统在 `PasswordUtil` 工具类中实现了用户密码的加密存储方案。该方案采用 **PBEWithMD5AndDES** 算法，这是一种基于密码的加密（Password-Based Encryption）算法，结合了MD5哈希和DES对称加密。

密码加密过程包含以下关键要素：
- **盐值（Salt）**：系统使用固定的盐值 `"63293188"`，该盐值在代码中硬编码。盐值用于增加密码哈希的复杂性，防止彩虹表攻击。
- **迭代次数**：设置为1000次，通过多次哈希迭代增加暴力破解的难度。
- **字符编码**：在加密前明确使用UTF-8编码处理明文密码，确保跨平台一致性。

`PasswordUtil` 提供了 `encrypt` 和 `decrypt` 方法，分别用于密码的加密存储和解密验证。当用户注册或修改密码时，系统调用 `encrypt` 方法生成密文并存储到数据库；用户登录时，将输入的密码用相同参数加密后与数据库存储的密文进行比对。

尽管该方案提供了基础的安全性，但使用固定盐值是一个潜在弱点，理想情况下应为每个用户生成唯一的随机盐值。

**Section sources**
- [PasswordUtil.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/PasswordUtil.java#L27-L33)

## 全局异常处理与错误响应

系统通过 `GlobalExceptionHandler` 类实现全局异常的统一捕获和处理。该类使用 `@RestControllerAdvice` 注解，作为Spring MVC的全局异常处理器，能够拦截所有控制器抛出的异常。

该处理器主要捕获两类异常：
1. **BusinessException**：自定义业务异常，通常由业务逻辑校验失败引发。处理器会记录错误日志，并返回包含具体错误码和消息的标准化响应。
2. **RuntimeException**：系统运行时异常，代表未预期的程序错误。处理器会记录详细的错误堆栈，并返回通用的“系统错误”提示，避免将敏感的内部信息暴露给客户端。

通过 `ResultUtils` 工具类，异常处理器能够生成符合 `BaseResponse` 格式的响应体，确保所有API接口返回一致的错误结构。这种设计有效防止了信息泄露，提升了系统的安全性和用户体验。

**Section sources**
- [GlobalExceptionHandler.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/exception/GlobalExceptionHandler.java#L20-L29)
- [ResultUtils.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/ResultUtils.java#L31-L33)

## 输入校验与敏感信息防护

系统实现了多层次的输入校验与敏感信息防护机制。

在输入校验方面，`StrAttackFilter` 类提供了一个简单的字符串过滤方法，用于清除文件上传等场景中的特殊字符。该过滤器通过正则表达式匹配并移除一系列潜在的危险字符，如引号、括号、尖括号等，有助于防御SQL注入和XSS攻击。然而，该过滤器仅作为辅助手段，其规则较为基础，不能完全替代参数化查询等更安全的防护措施。

在敏感信息处理方面，系统通过 `getUserVO` 和 `getLoginUserVO` 等方法实现数据脱敏。这些方法将原始的 `User` 实体对象转换为 `UserVO`（View Object）视图对象，过程中会移除密码、盐值等敏感字段，仅返回前端需要的安全信息。这种设计确保了即使在数据查询接口中，用户的敏感信息也不会被意外暴露。

**Section sources**
- [StrAttackFilter.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/filter/StrAttackFilter.java#L14-L19)
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L130-L134)

## API调用频率限制与Token管理

根据现有代码分析，该项目**未直接实现**API调用频率限制（Rate Limiting）功能。代码库中未发现如Guava RateLimiter、Redis计数器或Spring Cloud Gateway限流等常见的限流组件或逻辑。

在Token管理方面，系统目前基于HTTP Session进行用户状态管理。`application.yml` 配置文件中设置了Session的超时时间为30天（2592000秒），并通过Cookie传输Session ID。配置中注释提到“取消注释开启分布式session（须先配置Redis）”，表明系统设计上支持通过Redis实现分布式Session，但当前可能未启用。这种基于Session的认证方式相对传统，Token的有效期管理依赖于Session的生命周期。

**Section sources**
- [application.yml](file://yun-docker-master/src/main/resources/application.yml#L27-L28)

## WebSocket连接安全

系统在 `yun-docker-worker` 模块中通过 `WebSocketServer` 类实现WebSocket服务端。该服务通过 `/webSocket/{userId}` 路径接收连接，并在 `onOpen` 方法中记录用户ID，建立用户与WebSocket会话的映射关系。

然而，当前的WebSocket连接**缺乏有效的鉴权机制**。服务端仅接收前端传入的 `userId`，但未验证该用户是否已登录或其身份的真实性。攻击者可以伪造任意 `userId` 建立连接，从而可能接收到不属于该用户的数据或执行未授权的操作。此外，`onMessage` 方法中虽然有注释提到“把YunContainerService.isCtr2User()改造为远程调用方法”，但该功能被注释掉，表明容器访问的权限校验尚未在WebSocket通信中实现。

**Section sources**
- [WebSocketServer.java](file://yun-docker-worker/src/main/java/com/lfc/yundocker/worker/websocket/WebSocketServer.java#L52-L54)

## 潜在风险点与加固建议

综合分析，系统存在以下潜在安全风险点及相应的加固建议：

1. **密码存储方案薄弱**：使用固定盐值的PBEWithMD5AndDES算法安全性不足。**建议**：升级为更安全的算法，如BCrypt、SCrypt或PBKDF2，并为每个用户生成唯一的随机盐值。

2. **WebSocket缺乏鉴权**：连接建立时未验证用户身份。**建议**：在 `onOpen` 方法中增加Token验证逻辑，要求客户端在连接时提供有效的认证Token，并在服务端进行校验。

3. **缺少API限流**：系统可能面临暴力破解或DDoS攻击风险。**建议**：引入Redis和AOP，实现基于IP或用户ID的请求频率限制。

4. **Session管理待完善**：分布式Session功能被注释，可能导致集群环境下登录状态失效。**建议**：完成Redis配置，启用分布式Session，确保系统的可扩展性。

5. **输入校验不充分**：`StrAttackFilter` 过滤规则较为简单。**建议**：在关键接口（如SQL执行）中采用参数化查询，并对用户输入进行更严格的白名单校验。

通过实施上述加固建议，可显著提升系统的整体安全防护水平。

**Section sources**
- [PasswordUtil.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/PasswordUtil.java#L27-L28)
- [WebSocketServer.java](file://yun-docker-worker/src/main/java/com/lfc/yundocker/worker/websocket/WebSocketServer.java#L52-L54)
- [application.yml](file://yun-docker-master/src/main/resources/application.yml#L26-L27)