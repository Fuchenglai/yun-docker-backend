# 数据库设计

<cite>
**本文档引用的文件**   
- [yun_docker.sql](file://sql/yun_docker.sql)
- [create_table.sql](file://sql/create_table.sql)
- [User.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/User.java)
- [YunContainer.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunContainer.java)
- [YunImage.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunImage.java)
- [YunOrder.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunOrder.java)
- [YunPort.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunPort.java)
- [DistributeID.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/id/DistributeID.java)
- [UserMapper.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/mapper/UserMapper.java)
- [YunContainerMapper.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/mapper/YunContainerMapper.java)
- [YunImageMapper.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/mapper/YunImageMapper.java)
- [YunOrderMapper.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/mapper/YunOrderMapper.java)
- [YunPortMapper.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/mapper/YunPortMapper.java)
</cite>

## 目录
1. [数据库设计](#数据库设计)
2. [核心表结构详解](#核心表结构详解)
3. [实体关系图（ER图）](#实体关系图（er图）)
4. [Java实体类映射](#java实体类映射)
5. [关键设计决策](#关键设计决策)
6. [典型查询示例](#典型查询示例)
7. [结论](#结论)

## 核心表结构详解

### 用户表（user）

用户表存储系统中所有用户的基本信息，包括账号、密码、昵称、余额等。

**字段定义：**
- `id`：bigint，主键，自增，用户唯一标识
- `user_account`：varchar(50)，非空，用户账号，唯一标识登录名
- `user_password`：varchar(512)，非空，用户密码（MD5加密存储）
- `user_name`：varchar(50)，可为空，用户自定义昵称
- `user_avatar`：varchar(512)，可为空，用户头像URL
- `phone`：varchar(20)，可为空，用户手机号
- `balance`：int，非空，默认值1000，用户积分余额
- `user_role`：varchar(256)，非空，默认值'user'，用户角色（user/admin/ban）
- `create_time`：datetime，非空，默认当前时间，创建时间
- `update_time`：datetime，非空，默认当前时间并随更新自动刷新，更新时间
- `is_delete`：tinyint，非空，默认值0，逻辑删除标记（0-未删除，1-已删除）

**约束与索引：**
- 主键：`id`
- 逻辑删除：`is_delete` 字段配合 MyBatis Plus 的 `@TableLogic` 实现软删除
- 业务约束：账号唯一性通过业务逻辑校验保证

**业务含义：**
该表是系统的核心身份表，`balance` 字段用于记录用户可用积分，支持容器运行时的计费扣款。

**Section sources**
- [yun_docker.sql](file://sql/yun_docker.sql#L24-L37)
- [create_table.sql](file://sql/create_table.sql#L10-L23)
- [User.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/User.java#L16-L78)

### 镜像表（yun_image）

镜像表存储Docker镜像的元数据信息，包括公共和私有镜像。

**字段定义：**
- `id`：bigint，主键，自增，镜像唯一标识
- `repository`：varchar(256)，非空，镜像仓库名称
- `tag`：varchar(256)，非空，默认值'latest'，镜像标签
- `image_id`：varchar(256)，可为空，Docker系统中的镜像ID
- `image_size`：double，可为空，镜像大小（MB）
- `image_type`：tinyint，非空，默认值0，镜像类型（0-公共，1-私有）
- `user_id`：bigint，可为空，创建者用户ID（私有镜像时关联）
- `port`：int，可为空，默认值0，镜像对外暴露的端口
- `create_time`：datetime，非空，默认当前时间，创建时间
- `update_ime`：datetime，非空，默认当前时间并随更新自动刷新，更新时间
- `is_delete`：tinyint，非空，默认值0，逻辑删除标记

**约束与索引：**
- 主键：`id`
- 索引：`idx_userId`（user_id），用于快速查询用户创建的镜像
- 逻辑删除：`is_delete` 字段实现软删除

**业务含义：**
该表管理所有可用镜像，公共镜像（image_type=0）对所有用户可见，私有镜像（image_type=1）仅创建者可见。

**Section sources**
- [yun_docker.sql](file://sql/yun_docker.sql#L74-L89)
- [create_table.sql](file://sql/create_table.sql#L26-L40)
- [YunImage.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunImage.java#L21-L78)

### 容器表（yun_container）

容器表记录用户创建的Docker容器实例的运行状态和配置。

**字段定义：**
- `id`：bigint，主键，自增，容器唯一标识
- `image_id`：bigint，非空，关联的镜像ID
- `user_id`：bigint，非空，创建容器的用户ID
- `container_id`：varchar(256)，非空，Docker系统中的容器ID
- `command`：varchar(256)，可为空，启动命令
- `status`：varchar(20)，可为空，容器运行状态（running, exited等）
- `ports`：varchar(64)，可为空，端口映射信息（如"9096:8080/tcp"）
- `container_name`：varchar(256)，可为空，用户自定义容器名称
- `create_time`：datetime，非空，默认当前时间，创建时间
- `update_time`：datetime，非空，默认当前时间并随更新自动刷新，更新时间

**约束与索引：**
- 主键：`id`
- 索引：`idx_postId`（image_id），`idx_userId`（user_id），用于快速查询镜像或用户相关的容器

**业务含义：**
该表记录每个容器实例的元数据，实现用户对容器的生命周期管理。

**Section sources**
- [yun_docker.sql](file://sql/yun_docker.sql#L49-L64)
- [create_table.sql](file://sql/create_table.sql#L43-L57)
- [YunContainer.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunContainer.java#L22-L79)

### 订单表（yun_order）

订单表记录用户的积分充值订单信息。

**字段定义：**
- `id`：bigint，主键，自增，订单唯一标识
- `buyer_id`：bigint，非空，购买者用户ID
- `order_id`：varchar(64)，非空，商户订单号（业务唯一）
- `credit`：int，非空，充值积分数量
- `money`：DECIMAL(10,2)，非空，支付金额（元），精确到分
- `status`：TINYINT，非空，默认值0，订单状态（0-待支付,1-支付成功,2-支付失败,3-已取消）
- `trade_no`：varchar(64)，可为空，支付宝交易号
- `create_time`：DATETIME，非空，默认当前时间，创建时间
- `finished_time`：DATETIME，可为空，支付完成时间
- `cancel_time`：DATETIME，可为空，取消时间
- `is_delete`：tinyint，非空，默认值0，逻辑删除标记

**约束与索引：**
- 主键：`id`
- 业务主键：`order_id` 保证商户订单唯一性
- 逻辑删除：`is_delete` 字段实现软删除

**业务含义：**
该表管理所有充值订单，与支付宝支付系统集成，实现积分购买功能。

**Section sources**
- [yun_docker.sql](file://sql/yun_docker.sql#L119-L132)
- [create_table.sql](file://sql/create_table.sql#L69-L82)
- [YunOrder.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunOrder.java#L19-L76)

### 端口表（yun_port）

端口表管理系统中已分配的端口资源，防止端口冲突。

**字段定义：**
- `id`：bigint，主键，自增，记录唯一标识
- `port`：int，非空，端口号，唯一约束
- `create_time`：datetime，非空，默认当前时间，创建时间
- `update_time`：datetime，非空，默认当前时间并随更新自动刷新，更新时间

**约束与索引：**
- 主键：`id`
- 唯一索引：`port` 字段确保端口号全局唯一

**业务含义：**
该表用于端口资源的分配与管理，当创建容器时从该表分配可用端口。

**Section sources**
- [yun_docker.sql](file://sql/yun_docker.sql#L107-L114)
- [create_table.sql](file://sql/create_table.sql#L60-L66)
- [YunPort.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunPort.java#L23-L44)

## 实体关系图（ER图）

```mermaid
erDiagram
user {
bigint id PK
varchar(50) user_account UK
varchar(512) user_password
varchar(50) user_name
varchar(512) user_avatar
varchar(20) phone
int balance
varchar(256) user_role
datetime create_time
datetime update_time
tinyint is_delete
}
yun_image {
bigint id PK
varchar(256) repository
varchar(256) tag
varchar(256) image_id
double image_size
tinyint image_type
bigint user_id FK
int port
datetime create_time
datetime update_ime
tinyint is_delete
}
yun_container {
bigint id PK
bigint image_id FK
bigint user_id FK
varchar(256) container_id
varchar(256) command
varchar(20) status
varchar(64) ports
varchar(256) container_name
datetime create_time
datetime update_time
}
yun_order {
bigint id PK
bigint buyer_id FK
varchar(64) order_id UK
int credit
decimal(10,2) money
tinyint status
varchar(64) trade_no
datetime create_time
datetime finished_time
datetime cancel_time
tinyint is_delete
}
yun_port {
bigint id PK
int port UK
datetime create_time
datetime update_time
}
user ||--o{ yun_image : "创建"
user ||--o{ yun_container : "创建"
user ||--o{ yun_order : "购买"
yun_image ||--o{ yun_container : "实例化"
yun_port }|--|| yun_container : "使用"
```

**Diagram sources**
- [yun_docker.sql](file://sql/yun_docker.sql#L24-L114)
- [create_table.sql](file://sql/create_table.sql#L10-L82)

## Java实体类映射

### MyBatis-Plus注解使用

数据库表与Java实体类通过MyBatis-Plus的注解进行映射，主要使用以下注解：

- `@TableName`：指定实体类对应的数据库表名
- `@TableId`：标记主键字段，`type = IdType.AUTO` 表示使用数据库自增策略
- `@TableField`：配置字段映射，`exist = false` 表示非表字段，`value` 指定列名
- `@TableLogic`：标记逻辑删除字段，实现软删除功能

### 实体类与数据库字段映射

#### 用户实体（User）
- `id` → `id` (bigint, 主键)
- `userAccount` → `user_account` (varchar(50))
- `userPassword` → `user_password` (varchar(512))
- `userName` → `user_name` (varchar(50))
- `userAvatar` → `user_avatar` (varchar(512))
- `phone` → `phone` (varchar(20))
- `balance` → `balance` (int)
- `userRole` → `user_role` (varchar(256))
- `createTime` → `create_time` (datetime)
- `updateTime` → `update_time` (datetime)
- `isDelete` → `is_delete` (tinyint, @TableLogic)

#### 容器实体（YunContainer）
- `id` → `id` (bigint, 主键)
- `imageId` → `image_id` (bigint)
- `userId` → `user_id` (bigint)
- `containerId` → `container_id` (varchar(256))
- `command` → `command` (varchar(256))
- `status` → `status` (varchar(20))
- `ports` → `ports` (varchar(64))
- `containerName` → `container_name` (varchar(256))
- `createTime` → `create_time` (datetime)
- `updateTime` → `update_time` (datetime)

#### 镜像实体（YunImage）
- `id` → `id` (bigint, 主键)
- `repository` → `repository` (varchar(256))
- `tag` → `tag` (varchar(256))
- `imageId` → `image_id` (varchar(256))
- `imageSize` → `image_size` (double)
- `imageType` → `image_type` (tinyint)
- `userId` → `user_id` (bigint)
- `port` → `port` (int)
- `createTime` → `create_time` (datetime)
- `updateIme` → `update_ime` (datetime)
- `isDelete` → `is_delete` (tinyint, @TableLogic)

#### 订单实体（YunOrder）
- `id` → `id` (bigint, 主键)
- `buyerId` → `buyer_id` (bigint)
- `orderId` → `order_id` (varchar(64))
- `credit` → `credit` (int)
- `money` → `money` (decimal(10,2))
- `status` → `status` (tinyint)
- `tradeNo` → `trade_no` (varchar(64))
- `createTime` → `create_time` (datetime)
- `finishedTime` → `finished_time` (datetime)
- `cancelTime` → `cancel_time` (datetime)
- `isDelete` → `is_delete` (tinyint, @TableLogic)

#### 端口实体（YunPort）
- `id` → `id` (bigint, 主键)
- `port` → `port` (int)
- `createTime` → `create_time` (datetime)
- `updateTime` → `update_time` (datetime)

**Section sources**
- [User.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/User.java)
- [YunContainer.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunContainer.java)
- [YunImage.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunImage.java)
- [YunOrder.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunOrder.java)
- [YunPort.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunPort.java)

## 关键设计决策

### 分布式ID生成策略

系统采用自定义的 `DistributeID` 分布式ID生成器，避免在分布式环境下主键冲突。该策略生成的ID由三部分组成：

- **业务码（2位）**：来自 `BusinessCode` 枚举，如订单为"10"
- **序列号**：基于雪花算法生成的唯一序列
- **分表码（4位）**：基于 `DefaultShardingTableStrategy` 策略计算的分表编号

这种设计实现了：
1. 全局唯一性：结合雪花算法保证ID不重复
2. 业务可读性：前缀标识业务类型
3. 分库分表支持：末尾4位标识分表位置
4. 性能优化：避免数据库自增主键的性能瓶颈

```java
public static String generate(BusinessCode businessCode, String externalId, Long sequenceNumber)
```

**Section sources**
- [DistributeID.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/id/DistributeID.java)
- [BusinessCode.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/id/BusinessCode.java)
- [DefaultShardingTableStrategy.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/util/strategy/DefaultShardingTableStrategy.java)

### 积分余额精度控制

系统采用整数类型（int）存储积分余额，而非浮点类型，主要原因包括：

1. **避免浮点数精度问题**：积分系统要求精确计算，整数运算无精度损失
2. **简化业务逻辑**：积分以"分"为最小单位，直接存储整数值
3. **提高性能**：整数运算比浮点运算更快
4. **防止舍入误差**：避免多次加减操作累积的微小误差

余额更新采用SQL表达式实现原子操作：
```sql
UPDATE user SET balance = balance + ? WHERE id = ?
```

这种设计确保了在高并发场景下余额更新的准确性。

**Section sources**
- [User.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/User.java#L53)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L91-L102)

### 逻辑删除设计

系统采用MyBatis Plus的 `@TableLogic` 注解实现逻辑删除，而非物理删除：

- `is_delete` 字段标记删除状态
- 查询时自动过滤已删除记录
- 可实现数据恢复功能
- 保持数据完整性，便于审计

**Section sources**
- [User.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/User.java#L73-L74)
- [YunImage.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/common/model/entity/YunImage.java#L76-L77)

## 典型查询示例

### 查询用户创建的所有容器

**SQL示例：**
```sql
SELECT * FROM yun_container WHERE user_id = ? ORDER BY create_time DESC
```

**Mapper方法：**
```java
List<YunContainer> selectByUserId(@Param("userId") Long userId);
```

**Section sources**
- [yun_container](file://sql/yun_docker.sql#L50-L64)
- [YunContainerMapper.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/mapper/YunContainerMapper.java)

### 查询特定状态的订单

**SQL示例：**
```sql
SELECT * FROM yun_order WHERE buyer_id = ? AND status = ? AND create_time >= ?
```

**Mapper方法：**
```java
List<YunOrder> selectByStatusAndUser(@Param("buyerId") Long buyerId, @Param("status") Integer status, @Param("startTime") Date startTime);
```

**Section sources**
- [yun_order](file://sql/yun_docker.sql#L119-L132)
- [YunOrderMapper.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/mapper/YunOrderMapper.java)

### 检查端口是否已被占用

**SQL示例：**
```sql
SELECT COUNT(*) FROM yun_port WHERE port = ?
```

**Mapper方法：**
```java
int countByPort(@Param("port") Integer port);
```

**Section sources**
- [yun_port](file://sql/yun_docker.sql#L107-L114)
- [YunPortMapper.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/mapper/YunPortMapper.java)

### 更新用户余额（原子操作）

**SQL示例：**
```sql
UPDATE user SET balance = balance + ? WHERE id = ?
```

**Mapper方法：**
```java
@Update("UPDATE user SET balance = balance + #{cost} WHERE id = #{userId}")
void updateBalance(@Param("cost") Integer cost, @Param("userId") Long userId);
```

**Section sources**
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L91-L102)

## 结论

本数据库设计文档详细阐述了yun-docker-backend系统的核心数据模型。系统采用MySQL作为持久化存储，通过五张核心表（user、yun_image、yun_container、yun_order、yun_port）实现了用户管理、镜像管理、容器管理、订单管理和端口管理等核心功能。

关键设计亮点包括：
1. **分布式ID生成**：采用自定义的DistributeID策略，确保全局唯一性和分表支持
2. **逻辑删除**：通过`is_delete`字段和`@TableLogic`注解实现软删除
3. **精度控制**：积分余额使用整数类型存储，避免浮点数精度问题
4. **索引优化**：在高频查询字段上建立索引，提升查询性能
5. **MyBatis Plus集成**：充分利用注解简化ORM映射，提高开发效率

该设计既满足了当前业务需求，又具备良好的扩展性，为系统的稳定运行提供了坚实的数据基础。