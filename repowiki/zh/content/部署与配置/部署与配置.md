# 部署与配置

<cite>
**本文档引用文件**  
- [Dockerfile](file://Dockerfile)
- [pom.xml](file://pom.xml)
- [yun-docker-master/pom.xml](file://yun-docker-master/pom.xml)
- [yun-docker-worker/pom.xml](file://yun-docker-worker/pom.xml)
- [yun-docker-master/src/main/resources/application.yml](file://yun-docker-master/src/main/resources/application.yml)
- [yun-docker-master/src/main/resources/application-dev.yml](file://yun-docker-master/src/main/resources/application-dev.yml)
- [yun-docker-master/src/main/resources/application-prod.yml](file://yun-docker-master/src/main/resources/application-prod.yml)
- [yun-docker-worker/src/main/resources/application.yml](file://yun-docker-worker/src/main/resources/application.yml)
- [yun-docker-worker/src/main/resources/application-dev.yml](file://yun-docker-worker/src/main/resources/application-dev.yml)
- [yun-docker-worker/src/main/resources/application-prod.yml](file://yun-docker-worker/src/main/resources/application-prod.yml)
- [yun-docker-master/src/main/resources/prometheus.yml](file://yun-docker-master/src/main/resources/prometheus.yml)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [多环境配置管理](#多环境配置管理)
3. [Docker镜像构建](#docker镜像构建)
4. [Docker Compose服务编排](#docker-compose服务编排)
5. [Maven打包与JVM启动](#maven打包与jvm启动)
6. [运维最佳实践](#运维最佳实践)
7. [总结](#总结)

## 简介

云Docker后端系统是一个基于Spring Boot的微服务架构平台，旨在为开发者提供便捷的Web项目部署解决方案。系统包含master和worker两个核心服务，通过Dubbo进行RPC通信，使用Zookeeper作为注册中心，并集成支付宝沙箱支付、WebSocket实时通信等特性。本部署指南详细说明了开发、测试、生产多环境的配置与容器化部署流程。

**Section sources**
- [README.md](file://README.md#L1-L7)

## 多环境配置管理

### 配置文件激活机制

系统采用Spring Boot的标准配置文件激活机制，通过`spring.profiles.active`属性来指定当前激活的环境。在`yun-docker-master`和`yun-docker-worker`模块的`application.yml`文件中，均设置了默认激活的开发环境：

```yaml
spring:
  profiles:
    active: dev
```

此配置位于`application.yml`文件的第14-18行，当应用启动时，Spring Boot会自动加载`application-dev.yml`文件中的开发环境配置。可以通过以下方式覆盖默认配置：

1. **命令行参数**：`--spring.profiles.active=prod`
2. **环境变量**：`SPRING_PROFILES_ACTIVE=prod`
3. **JVM系统属性**：`-Dspring.profiles.active=prod`

### 开发与生产环境配置对比

#### 数据库连接配置

在开发环境(`application-dev.yml`)和生产环境(`application-prod.yml`)中，数据库连接配置保持一致，均使用本地MySQL数据库：

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/yun_docker?useUnicode=true&characterEncoding=utf-8&serverTimezone=Asia/Shanghai
    username: root
    password: 123456
```

此配置位于`yun-docker-master/src/main/resources/application-dev.yml`和`application-prod.yml`文件的第16-20行。实际部署时需要根据生产环境的数据库地址和凭据进行修改。

#### 日志级别配置

开发环境与生产环境在日志级别配置上存在显著差异，主要体现在MyBatis-Plus的日志输出设置：

- **开发环境**：启用SQL日志输出，便于调试和开发
```yaml
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

- **生产环境**：关闭日志输出，提升性能
```yaml
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.nologging.NoLoggingImpl
```

此差异配置位于`yun-docker-master/src/main/resources/application-dev.yml`第36-37行和`application-prod.yml`第37-38行。

#### Dubbo注册中心地址

两个环境的Dubbo注册中心地址配置完全相同，均指向本地Zookeeper服务：

```yaml
dubbo:
  registry:
    address: zookeeper://${zookeeper.address:127.0.0.1}:2181
```

此配置位于`yun-docker-master/src/main/resources/application-dev.yml`和`application-prod.yml`文件的第10-11行。`${zookeeper.address:127.0.0.1}`表示使用环境变量`zookeeper.address`的值，若未设置则默认使用`127.0.0.1`。

**Section sources**
- [yun-docker-master/src/main/resources/application.yml](file://yun-docker-master/src/main/resources/application.yml#L14-L18)
- [yun-docker-master/src/main/resources/application-dev.yml](file://yun-docker-master/src/main/resources/application-dev.yml#L16-L20)
- [yun-docker-master/src/main/resources/application-prod.yml](file://yun-docker-master/src/main/resources/application-prod.yml#L16-L20)
- [yun-docker-master/src/main/resources/application-dev.yml](file://yun-docker-master/src/main/resources/application-dev.yml#L36-L37)
- [yun-docker-master/src/main/resources/application-prod.yml](file://yun-docker-master/src/main/resources/application-prod.yml#L37-L38)
- [yun-docker-master/src/main/resources/application-dev.yml](file://yun-docker-master/src/main/resources/application-dev.yml#L10-L11)
- [yun-docker-master/src/main/resources/application-prod.yml](file://yun-docker-master/src/main/resources/application-prod.yml#L10-L11)

## Docker镜像构建

### Dockerfile详解

项目根目录下的`Dockerfile`定义了`yun-docker-master`模块的镜像构建过程：

```dockerfile
# 使用官方OpenJDK 8基础镜像
FROM openjdk:8-jdk-alpine

# 构建镜像时所需要执行的命令，这里作者是在容器内部创建了一个工作目录
RUN mkdir "/home/app"

# 设置工作目录
WORKDIR /home/app

# 将构建的jar包复制到容器中
ARG JAR_FILE=target/*.jar
COPY ${JAR_FILE} app.jar

# 暴露应用运行的端口（根据您的Spring Boot应用配置）
EXPOSE 8088

# 启动应用
ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 基础镜像选择

采用`openjdk:8-jdk-alpine`作为基础镜像，具有以下优势：
- **轻量化**：Alpine Linux基础镜像体积小，通常在5MB左右，使得最终镜像体积更小
- **安全性**：Alpine Linux以安全性著称，减少了攻击面
- **兼容性**：OpenJDK 8是广泛支持的Java版本，确保应用的兼容性

#### 依赖拷贝与构建流程

Dockerfile通过`ARG JAR_FILE=target/*.jar`定义了一个构建参数，允许在构建时指定JAR文件路径。`COPY ${JAR_FILE} app.jar`命令将Maven打包生成的JAR文件复制到容器中并重命名为`app.jar`。这种设计使得Docker构建过程与Maven构建过程解耦，提高了灵活性。

#### 端口暴露

`EXPOSE 8088`指令声明了容器在运行时监听的端口。此端口与Spring Boot应用的配置一致（`server.port: 8088`），确保外部可以通过该端口访问应用。

#### 启动命令

`ENTRYPOINT ["java", "-jar", "app.jar"]`定义了容器启动时执行的命令。使用`ENTRYPOINT`而非`CMD`确保了该命令作为容器的主进程运行，便于容器生命周期管理。

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L18)

## Docker Compose服务编排

### 服务编排设计

虽然项目中未提供`docker-compose.yml`文件，但基于系统架构可以设计如下的服务编排方案，定义master、worker、zookeeper、mysql等服务的编排关系：

```yaml
version: '3.8'

services:
  zookeeper:
    image: zookeeper:3.7
    container_name: yun-docker-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888
    networks:
      - yun-docker-network

  mysql:
    image: mysql:8.0
    container_name: yun-docker-mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: yun_docker
    volumes:
      - ./sql:/docker-entrypoint-initdb.d
      - mysql-data:/var/lib/mysql
    networks:
      - yun-docker-network

  master:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yun-docker-master
    ports:
      - "8088:8088"
    environment:
      - spring.profiles.active=prod
      - zookeeper.address=zookeeper
    depends_on:
      - zookeeper
      - mysql
    volumes:
      - ./logs/master:/home/app/logs
      - ./config/master:/home/app/config
    networks:
      - yun-docker-network

  worker:
    build:
      context: .
      dockerfile: Dockerfile-worker
    container_name: yun-docker-worker
    ports:
      - "8089:8089"
    environment:
      - spring.profiles.active=prod
      - zookeeper.address=zookeeper
    depends_on:
      - zookeeper
    volumes:
      - ./logs/worker:/home/app/logs
      - ./config/worker:/home/app/config
    networks:
      - yun-docker-network

volumes:
  mysql-data:

networks:
  yun-docker-network:
    driver: bridge
```

此编排方案定义了四个核心服务：
- **zookeeper**：Dubbo服务注册与发现中心
- **mysql**：持久化数据存储，通过卷挂载实现数据持久化
- **master**：主服务，依赖zookeeper和mysql，暴露8088端口
- **worker**：工作服务，依赖zookeeper，暴露8089端口

**Section sources**
- [yun-docker-master/src/main/resources/application.yml](file://yun-docker-master/src/main/resources/application.yml#L34-L35)
- [yun-docker-worker/src/main/resources/application.yml](file://yun-docker-worker/src/main/resources/application.yml#L32-L33)

## Maven打包与JVM启动

### Maven打包命令

项目采用Maven作为构建工具，`pom.xml`文件中配置了Spring Boot的Maven插件，支持一键打包。执行以下命令进行打包：

```bash
mvn clean package
```

此命令会执行以下操作：
1. `clean`：清理target目录，删除之前构建生成的文件
2. `package`：编译源代码、运行测试、打包成JAR文件

在`yun-docker-master/pom.xml`文件中，配置了Spring Boot的Maven插件：

```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
        </plugin>
    </plugins>
</build>
```

此插件确保生成的JAR文件是可执行的Fat JAR，包含了所有依赖库和Spring Boot的启动器。

### JVM启动参数建议

为确保应用在生产环境稳定运行，建议使用以下JVM启动参数：

```bash
java -jar \
  -Xms512m \
  -Xmx1024m \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/home/app/logs/heapdump.hprof \
  -Dspring.profiles.active=prod \
  -Dlogging.config=classpath:logback-spring.xml \
  app.jar
```

参数说明：
- `-Xms512m -Xmx1024m`：设置JVM初始堆内存为512MB，最大堆内存为1024MB
- `-XX:+UseG1GC`：使用G1垃圾收集器，适合大内存应用
- `-XX:MaxGCPauseMillis=200`：目标最大GC暂停时间为200毫秒
- `-XX:+HeapDumpOnOutOfMemoryError`：发生OutOfMemoryError时生成堆转储文件
- `-XX:HeapDumpPath`：指定堆转储文件的保存路径
- `-Dspring.profiles.active=prod`：激活生产环境配置
- `-Dlogging.config`：指定日志配置文件路径

**Section sources**
- [yun-docker-master/pom.xml](file://yun-docker-master/pom.xml#L185-L192)
- [yun-docker-master/src/main/resources/application.yml](file://yun-docker-master/src/main/resources/application.yml#L17-L18)

## 运维最佳实践

### 健康检查

系统已集成Spring Boot Actuator监控端点，可通过`/actuator/health`进行健康检查。在`application.yml`中配置了暴露的监控端点：

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: always
```

建议在Docker或Kubernetes中配置以下健康检查：

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8088/api/actuator/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

### 日志输出路径

建议将应用日志输出到容器外部的持久化存储中，便于日志收集和分析。在Docker Compose中通过卷挂载实现：

```yaml
volumes:
  - ./logs/master:/home/app/logs
```

应用内部的日志配置（如logback-spring.xml）应将日志输出到`/home/app/logs`目录下，按日期和级别进行文件分割。

### 外部化配置挂载

为实现配置与代码的分离，建议将配置文件挂载到容器外部：

```yaml
volumes:
  - ./config/master:/home/app/config
```

启动时通过JVM参数指定配置文件位置：

```bash
java -jar -Dspring.config.location=/home/app/config/application.yml app.jar
```

这样可以在不重新构建镜像的情况下更新配置，提高部署灵活性。

### 监控与指标收集

系统已集成Prometheus监控，`yun-docker-master/src/main/resources/prometheus.yml`文件配置了监控目标：

```yaml
scrape_configs:
  - job_name: 'yun-docker-backend'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['localhost:8088']
```

建议部署Prometheus和Grafana进行指标收集和可视化展示，监控应用的JVM性能、HTTP请求、数据库连接等关键指标。

**Section sources**
- [yun-docker-master/src/main/resources/application.yml](file://yun-docker-master/src/main/resources/application.yml#L51-L58)
- [yun-docker-master/src/main/resources/prometheus.yml](file://yun-docker-master/src/main/resources/prometheus.yml#L7)

## 总结

本部署指南详细介绍了yun-docker-backend系统的多环境配置与容器化部署流程。系统采用Spring Boot + Dubbo的微服务架构，通过合理的配置管理、Docker容器化和Docker Compose服务编排，实现了开发、测试、生产环境的一致性部署。通过Maven标准化构建、JVM优化启动参数和运维最佳实践，确保了系统的稳定性、可维护性和可扩展性。建议在实际部署中根据具体环境调整配置参数，并建立完善的监控告警体系，保障系统稳定运行。