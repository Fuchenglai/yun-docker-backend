# 用户系统

<cite>
**本文档引用的文件**   
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java)
- [UserService.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/UserService.java)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java)
- [AuthCheck.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/annotation/AuthCheck.java)
- [AuthInterceptor.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/aop/AuthInterceptor.java)
- [UserConstant.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/constant/UserConstant.java)
- [UserRoleEnum.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/model/enums/UserRoleEnum.java)
- [UserRegisterRequest.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/model/dto/user/UserRegisterRequest.java)
- [UserLoginRequest.java](file://yun-docker-common/src/main/java/com/lfc/yundocker/common/model/dto/user/UserLoginRequest.java)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档深入解析用户系统的注册、登录、权限控制与信息管理全流程。系统通过 `UserController` 处理用户注册与登录请求，结合 `UserService` 实现业务逻辑，使用 `AuthInterceptor` 拦截器和 `@AuthCheck` 注解实现接口级权限控制，确保用户只能操作自己的资源。用户密码通过 MD5 加密存储，登录态通过 Session 维护，敏感信息通过 VO 对象脱敏返回。

## 项目结构
用户系统主要分布在 `yun-docker-master` 和 `yun-docker-common` 模块中，采用典型的分层架构设计。

```mermaid
graph TD
subgraph "yun-docker-master"
UserController[UserController]
UserService[UserService]
UserServiceImpl[UserServiceImpl]
AuthInterceptor[AuthInterceptor]
AuthCheck[AuthCheck]
end
subgraph "yun-docker-common"
UserConstant[UserConstant]
UserRoleEnum[UserRoleEnum]
UserRegisterRequest[UserRegisterRequest]
UserLoginRequest[UserLoginRequest]
end
UserController --> UserService
UserService --> UserServiceImpl
UserServiceImpl --> UserConstant
UserServiceImpl --> UserRoleEnum
AuthInterceptor --> UserService
AuthCheck --> AuthInterceptor
```

**图示来源**
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L31-L34)
- [UserService.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/UserService.java#L17-L18)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L38-L40)
- [AuthCheck.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/annotation/AuthCheck.java#L16-L18)
- [AuthInterceptor.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/aop/AuthInterceptor.java#L26-L28)

**本节来源**
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L1-L309)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L1-L301)

## 核心组件

系统核心组件包括用户控制器、用户服务、权限拦截器和注解，共同实现用户管理功能。

**本节来源**
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L31-L309)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L38-L301)

## 架构概览

系统采用 MVC 架构，结合 AOP 实现权限控制。

```mermaid
graph TB
Client[客户端] --> UserController
UserController --> UserService
UserService --> UserServiceImpl
UserServiceImpl --> UserMapper
UserMapper --> Database[(数据库)]
AuthInterceptor --> UserService
AuthCheck --> AuthInterceptor
style UserController fill:#f9f,stroke:#333
style UserService fill:#bbf,stroke:#333
style UserServiceImpl fill:#f96,stroke:#333
```

**图示来源**
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L31-L34)
- [UserService.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/UserService.java#L17-L18)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L38-L40)
- [UserMapper.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/mapper/UserMapper.java#L11-L13)

## 详细组件分析

### 用户注册与登录分析

#### 用户注册流程
```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "UserController"
participant Service as "UserServiceImpl"
Client->>Controller : POST /user/register
Controller->>Controller : 参数校验
Controller->>Service : userRegister()
Service->>Service : 账号密码校验
Service->>Service : MD5加密密码
Service->>Service : 生成随机用户名
Service->>Service : 插入数据库
Service-->>Controller : 返回用户ID
Controller-->>Client : 返回注册结果
```

**图示来源**
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L50-L63)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L48-L87)

#### 用户登录流程
```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "UserController"
participant Service as "UserServiceImpl"
Client->>Controller : POST /user/login
Controller->>Controller : 参数校验
Controller->>Service : userLogin()
Service->>Service : 密码MD5加密
Service->>Service : 查询数据库
Service->>Service : 验证密码
Service->>Service : 设置Session
Service-->>Controller : 返回LoginUserVO
Controller-->>Client : 返回登录结果
```

**图示来源**
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L72-L83)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L106-L137)

### 权限控制分析

#### 权限拦截机制
```mermaid
classDiagram
class AuthCheck {
+String mustRole()
}
class AuthInterceptor {
-UserService userService
+Object doInterceptor()
}
class UserService {
+User getLoginUser()
+boolean isAdmin()
}
AuthCheck --> AuthInterceptor : "注解驱动"
AuthInterceptor --> UserService : "依赖"
```

**图示来源**
- [AuthCheck.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/annotation/AuthCheck.java#L16-L28)
- [AuthInterceptor.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/aop/AuthInterceptor.java#L26-L70)
- [UserService.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/UserService.java#L54-L78)

#### 用户信息脱敏
```mermaid
flowchart TD
Start([获取用户信息]) --> GetEntity["获取User实体"]
GetEntity --> CheckLogin{"是否登录?"}
CheckLogin --> |是| CreateVO["创建UserVO/LoginUserVO"]
CheckLogin --> |否| ReturnNull["返回空"]
CreateVO --> CopyProps["复制属性"]
CopyProps --> RemoveSensitive["移除敏感字段"]
RemoveSensitive --> ReturnVO["返回VO对象"]
ReturnVO --> End([完成])
```

**图示来源**
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L248-L265)
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L130-L134)

**本节来源**
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L50-L309)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L48-L301)
- [AuthInterceptor.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/aop/AuthInterceptor.java#L26-L70)
- [AuthCheck.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/annotation/AuthCheck.java#L16-L28)

## 依赖分析

系统组件间依赖关系清晰，遵循分层架构原则。

```mermaid
graph TD
UserController --> UserService
UserService --> UserServiceImpl
UserServiceImpl --> UserMapper
AuthInterceptor --> UserService
UserServiceImpl --> UserConstant
UserServiceImpl --> UserRoleEnum
```

**图示来源**
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L36-L37)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L40-L41)
- [AuthInterceptor.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/aop/AuthInterceptor.java#L30-L31)

**本节来源**
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L36-L37)
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L40-L41)
- [AuthInterceptor.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/aop/AuthInterceptor.java#L30-L31)

## 性能考虑

系统在用户登录和权限校验方面有以下性能考虑：
- 登录态存储在 Session 中，减少数据库查询
- 权限校验通过内存中的角色判断，提高响应速度
- 使用 MyBatis Plus 分页查询，支持大数据量分页
- 对用户查询接口限制每页最大20条记录，防止爬虫

## 故障排除指南

常见问题及解决方案：

| 问题现象 | 可能原因 | 解决方案 |
|--------|--------|--------|
| 注册失败 | 账号重复 | 更换账号重新注册 |
| 登录失败 | 密码错误 | 确认密码正确性 |
| 接口403 | 权限不足 | 检查用户角色 |
| 余额不足 | 余额低于300 | 充值后重试 |

**本节来源**
- [UserServiceImpl.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/service/impl/UserServiceImpl.java#L295-L297)
- [UserController.java](file://yun-docker-master/src/main/java/com/lfc/yundocker/controller/UserController.java#L236-L240)

## 结论

用户系统实现了完整的注册、登录、权限控制和信息管理功能。系统通过分层架构设计，将控制器、服务和数据访问层分离，提高了代码的可维护性。权限控制通过 AOP 和注解实现，具有良好的扩展性。密码通过 MD5 加密存储，登录态通过 Session 维护，敏感信息通过 VO 对象脱敏返回，保障了系统安全性。